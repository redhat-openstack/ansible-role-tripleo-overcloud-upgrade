#!/bin/bash
set -eux
source {{ upgrade_working_dir }}/stackrc

# Workaround for rdo overcloud images
# This package, which comes with python-tripleoclient do a rsync --delete on
# /usr/libexec/os-refresh-config and cause the hanging of heat after the yum update
# on major controller upgrade step 1
# Just add a basic yum remove before upgrading, and waiting for the fix of the rdo image
# or https://bugzilla.redhat.com/show_bug.cgi?id=1347652
{% if target_upgrade_version == 'mitaka' %}
echo "remove t-i-e package on overcloud"
for i in $(nova list|grep ctlplane|awk -F' ' '{ print $12 }'|awk -F'=' '{ print $2 }'); do
    ssh -o StrictHostKeyChecking=no heat-admin@$i "sudo yum remove -y openstack-tripleo-image-elements"
done
{% endif %}

echo "execute script delivery"
openstack overcloud deploy --templates {{ tht_dir }} \
    -e tripleo-heat-templates/overcloud-resource-registry-puppet.yaml \
{% if network_isolation == true %}
    -e {{ tht_dir }}/environments/network-isolation.yaml \
    -e {{ tht_dir }}/environments/net-single-nic-with-vlans.yaml \
    -e ~/network-environment.yaml \
{% endif %}
    -e {{ tht_dir }}/environments/puppet-pacemaker.yaml \
    -e {{ tht_dir }}/environments/major-upgrade-pacemaker-init.yaml \
{% for item in upgrade_custom_templates_script_delivery %}
    -e {{ item }} \
{% endfor %}

echo "get ceph uuid and update swift"
for swift in $(nova list | grep swift  | awk '{ print $2; }'); do
    echo "Run upgrade on $swift"
    {{ upgrade_non_controller_script }} --upgrade  $swift
done

{% if target_upgrade_version == 'mitaka' %}
# To remove when those review will merge to tht:
# Get the upstream THT repo, then get the review:
# aodh / keystone / mariadb
mv tripleo-heat-templates tripleo-heat-templates.org
git clone https://github.com/openstack/tripleo-heat-templates.git -b stable/mitaka
pushd tripleo-heat-templates
git config user.email "mat.bultel@gmail.com"
git config user.name "matbu"
# aodh
# https://review.openstack.org/#/c/320150/
git fetch https://review.openstack.org/openstack/tripleo-heat-templates refs/changes/50/320150/19 && git checkout FETCH_HEAD
git fetch https://review.openstack.org/openstack/tripleo-heat-templates refs/changes/55/329655/2 && git checkout FETCH_HEAD
popd

openstack overcloud deploy --templates {{ tht_dir }} \
    -e tripleo-heat-templates/overcloud-resource-registry-puppet.yaml \
{% if network_isolation == true %}
    -e {{ tht_dir }}/environments/network-isolation.yaml \
    -e {{ tht_dir }}/environments/net-single-nic-with-vlans.yaml \
    -e ~/network-environment.yaml \
{% endif %}
    -e {{ tht_dir }}/environments/puppet-pacemaker.yaml \
{% for item in upgrade_custom_templates_controller %}
    -e {{ item }} \
{% endfor %}
    -e {{ tht_dir }}/environments/major-upgrade-aodh.yaml

# keystone
# https://review.openstack.org/302235
pushd tripleo-heat-templates
git fetch https://review.openstack.org/openstack/tripleo-heat-templates refs/changes/35/302235/17 && git checkout FETCH_HEAD
popd

openstack overcloud deploy --templates {{ tht_dir }} \
    -e tripleo-heat-templates/overcloud-resource-registry-puppet.yaml \
{% if network_isolation == true %}
    -e {{ tht_dir }}/environments/network-isolation.yaml \
    -e {{ tht_dir }}/environments/net-single-nic-with-vlans.yaml \
    -e ~/network-environment.yaml \
{% endif %}
    -e {{ tht_dir }}/environments/puppet-pacemaker.yaml \
{% for item in upgrade_custom_templates_controller %}
    -e {{ item }} \
{% endfor %}
    -e {{ tht_dir }}/environments/major-upgrade-keystone-liberty-mitaka.yaml

# Mariadb upgrade:
# https://review.openstack.org/#/c/325205/
pushd tripleo-heat-templates
git fetch https://review.openstack.org/openstack/tripleo-heat-templates refs/changes/05/325205/10 && git checkout FETCH_HEAD
popd
{% endif %}

echo "execute major upgrade controller"
openstack overcloud deploy --templates {{ tht_dir }} \
    -e tripleo-heat-templates/overcloud-resource-registry-puppet.yaml \
{% if network_isolation == true %}
    -e {{ tht_dir }}/environments/network-isolation.yaml \
    -e {{ tht_dir }}/environments/net-single-nic-with-vlans.yaml \
    -e ~/network-environment.yaml \
{% endif %}
    -e {{ tht_dir }}/environments/puppet-pacemaker.yaml \
{% for item in upgrade_custom_templates_controller %}
    -e {{ item }} \
{% endfor %}
    -e {{ tht_dir }}/environments/major-upgrade-pacemaker.yaml

echo "get compute uuid and update compute"
for compute in $(nova list | grep compute  | awk '{ print $2; }'); do
    echo "Run upgrade on $compute"
    {{ upgrade_non_controller_script }} --upgrade  $compute
done

echo "get ceph uuid and update ceph"
for ceph in $(nova list | grep cephstorage  | awk '{ print $2; }'); do
    echo "Run upgrade on $ceph"
    {{ upgrade_non_controller_script }} --upgrade  $ceph
done

echo "execute converge"
openstack overcloud deploy --templates {{ tht_dir }} \
    -e tripleo-heat-templates/overcloud-resource-registry-puppet.yaml \
    -e tripleo-heat-templates/environments/puppet-pacemaker.yaml \
    -e tripleo-heat-templates/environments/major-upgrade-pacemaker-converge.yaml \
{% for item in upgrade_custom_templates_converge %}
    -e {{ item }} \
{% endfor %}
{% if network_isolation == true %}
    -e {{ tht_dir }}/environments/network-isolation.yaml \
    -e {{ tht_dir }}/environments/net-single-nic-with-vlans.yaml \
    -e ~/network-environment.yaml
{% endif %}

echo "check upgrade status"
heat stack-list | grep -i COMPLETE
